// script.js

// Variables globales
let ingresos = [];
let gastos = [];

document.addEventListener("DOMContentLoaded", () => {
    actualizarResumen();
});

// Función para agregar un ingreso
function agregarIngreso() {
    try {
        let fuente = document.getElementById("fuente").value.trim();
        let monto = parseFloat(document.getElementById("monto-ingreso").value);
        let fecha = document.getElementById("fecha-ingreso").value;

        // Validaciones
        if (!fuente || isNaN(monto) || monto <= 0 || !fecha) {
            throw new Error("Por favor, ingresa datos válidos.");
        }

        ingresos.push({ fuente, monto, fecha });
        actualizarLista("lista-ingresos", ingresos, true);
        actualizarResumen();
        limpiarCampos(["fuente", "monto-ingreso", "fecha-ingreso"]);
    } catch (error) {
        alert(error.message);
    }
}

// Función para agregar un gasto
function agregarGasto() {
    try {
        let descripcion = document.getElementById("descripcion").value.trim();
        let monto = parseFloat(document.getElementById("monto").value);
        let categoria = document.getElementById("categoria").value;
        let fecha = document.getElementById("fecha-gasto").value;

        // Validaciones
        if (!descripcion || isNaN(monto) || monto <= 0 || !fecha) {
            throw new Error("Por favor, ingresa datos válidos.");
        }

        gastos.push({ descripcion, monto, categoria, fecha });
        actualizarLista("lista-gastos", gastos, false);
        actualizarResumen();
        limpiarCampos(["descripcion", "monto", "fecha-gasto"]);
    } catch (error) {
        alert(error.message);
    }
}

// Función para actualizar las listas de ingresos y gastos
function actualizarLista(idLista, lista, esIngreso) {
    let ul = document.getElementById(idLista);
    ul.innerHTML = "";

    lista.forEach((item, index) => {
        let li = document.createElement("li");
        li.textContent = esIngreso
            ? `${item.fuente} - S/ ${item.monto} (${item.fecha})`
            : `${item.descripcion} - S/ ${item.monto} (${item.categoria}) - ${item.fecha}`;

        let btnEliminar = document.createElement("button");
        btnEliminar.textContent = "❌";
        btnEliminar.onclick = () => eliminarElemento(index, esIngreso);
        li.appendChild(btnEliminar);
        ul.appendChild(li);
    });
}

// Función para eliminar un ingreso o gasto
function eliminarElemento(index, esIngreso) {
    if (esIngreso) {
        ingresos.splice(index, 1);
    } else {
        gastos.splice(index, 1);
    }
    actualizarLista(esIngreso ? "lista-ingresos" : "lista-gastos", esIngreso ? ingresos : gastos, esIngreso);
    actualizarResumen();
}

// Función para actualizar el total de ingresos, gastos y saldo
function actualizarResumen() {
    let totalIngresos = ingresos.reduce((sum, ingreso) => sum + ingreso.monto, 0);
    let totalGastos = gastos.reduce((sum, gasto) => sum + gasto.monto, 0);
    let saldo = totalIngresos - totalGastos;

    document.getElementById("total-ingresos").textContent = totalIngresos.toFixed(2);
    document.getElementById("total-gastos").textContent = totalGastos.toFixed(2);
    document.getElementById("saldo").textContent = saldo.toFixed(2);
}

// Función para limpiar los campos después de ingresar datos
function limpiarCampos(ids) {
    ids.forEach(id => document.getElementById(id).value = "");
}

// Función para descargar reporte en Excel
function descargarExcel() {
    try {
        let wb = XLSX.utils.book_new();
        let wsIngresos = XLSX.utils.json_to_sheet(ingresos);
        let wsGastos = XLSX.utils.json_to_sheet(gastos);

        XLSX.utils.book_append_sheet(wb, wsIngresos, "Ingresos");
        XLSX.utils.book_append_sheet(wb, wsGastos, "Gastos");

        XLSX.writeFile(wb, "Control_Finanzas.xlsx");
    } catch (error) {
        alert("Error al generar el archivo Excel: " + error.message);
    }
}
